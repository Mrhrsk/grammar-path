<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrammarPath: Complete English Curriculum Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Scrollbar for cleaner UI */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Chart Container Best Practices */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Card Hover Effects */
        .topic-card {
            transition: all 0.2s ease-in-out;
        }
        .topic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Tab Active State */
        .tab-active {
            border-bottom: 3px solid #475569;
            color: #1e293b;
            font-weight: 600;
        }
        .tab-inactive {
            color: #64748b;
            border-bottom: 3px solid transparent;
        }
        .tab-inactive:hover {
            color: #334155;
            border-bottom: 3px solid #cbd5e1;
        }

        /* Markdown Styles for AI Content */
        .ai-content h1, .ai-content h2, .ai-content h3 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
        .ai-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .ai-content ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .ai-content p { margin-bottom: 1em; }
        .ai-content strong { color: #4338ca; } /* Indigo-700 for bold AI text */
    </style>
</head>
<body class="bg-stone-50 text-slate-800 font-sans min-h-screen flex flex-col">

<!-- Chosen Palette: Academic Calm (Warm Neutral Backgrounds #fafaf9, Slate Blue/Grey text #1e293b, Sage Green accents, Muted Terracotta for complexity) -->

<!-- Application Structure Plan:
     1. Header: Value proposition and context.
     2. Main Nav (Tabs): CEFR Levels (A1-C2). This creates a logical segmentation of the massive dataset.
     3. Level Dashboard:
        - Intro Text: Contextualizes the level's goals.
        - Stats Row: Visualizes the makeup of the level (Tenses vs Structure vs Vocabulary).
        - Topic Grid: The core content. Chronological list of topics.
     4. Topic Detail (Modal/Overlay): Deep dive into a specific topic with teaching tips and examples.
     5. Global Roadmap: A visual summary of the journey.
     WHY: This structure allows the user (teacher) to zoom in on specific lesson planning needs while maintaining awareness of the broader curriculum arc.
-->

<!-- Visualization & Content Choices:
     1. Doughnut Chart (Chart.js): Shows 'Topic Distribution' (e.g., how much is Tense-based vs Noun-based). Helps teachers balance their lesson variety.
     2. Bar Chart (Chart.js): 'Complexity Score'. Shows the relative cognitive load of topics in the level.
     3. Interactive Cards: Used for individual grammar points. Goal: Organize. Click to reveal teaching strategies.
     4. Progress Toggles: Simple checkbox interaction to let teachers mark topics as "Prepared".
     CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
-->

<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

<!-- Header Section -->
<header class="bg-white border-b border-stone-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <div class="flex items-center">
                <span class="text-2xl font-bold text-slate-700 tracking-tight">GrammarPath</span>
                <span class="ml-3 px-2 py-1 bg-stone-100 text-xs font-medium text-stone-600 rounded">Teacher's Edition</span>
            </div>
            <div class="hidden md:flex space-x-8">
                <button onclick="app.showSection('curriculum')" class="text-slate-600 hover:text-slate-900 px-3 py-2 rounded-md text-sm font-medium">Curriculum</button>
                <button onclick="app.showSection('roadmap')" class="text-slate-600 hover:text-slate-900 px-3 py-2 rounded-md text-sm font-medium">Global Roadmap</button>
            </div>
        </div>
    </div>
</header>

<!-- Main Content Area -->
<main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

    <!-- INTRO CONTEXT -->
    <div class="mb-10 text-center max-w-3xl mx-auto">
        <h1 class="text-3xl font-bold text-slate-800 mb-4">A Progressive English Grammar Curriculum</h1>
        <p class="text-lg text-slate-600">
            This interactive guide outlines the optimal sequence for teaching English grammar.
            Starting from absolute zero (A1) to near-native proficiency (C2), topics are ordered to minimize cognitive overload and maximize retention.
            Select a proficiency level below to explore the syllabus.
        </p>
    </div>

    <!-- VIEW: CURRICULUM -->
    <div id="view-curriculum" class="space-y-6">

        <!-- Level Navigation Tabs -->
        <div class="border-b border-stone-200">
            <nav class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Tabs">
                <button onclick="app.loadLevel('A1')" id="tab-A1" class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm w-1/6 text-center">A1: Starter</button>
                <button onclick="app.loadLevel('A2')" id="tab-A2" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm w-1/6 text-center">A2: Elementary</button>
                <button onclick="app.loadLevel('B1')" id="tab-B1" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm w-1/6 text-center">B1: Intermediate</button>
                <button onclick="app.loadLevel('B2')" id="tab-B2" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm w-1/6 text-center">B2: Upper Int</button>
                <button onclick="app.loadLevel('C1')" id="tab-C1" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm w-1/6 text-center">C1: Advanced</button>
                <button onclick="app.loadLevel('C2')" id="tab-C2" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm w-1/6 text-center">C2: Mastery</button>
            </nav>
        </div>

        <!-- Level Dashboard -->
        <div id="level-content" class="animate-fade-in">
            <!-- DYNAMIC CONTENT LOADED HERE via JS -->
        </div>

    </div>

    <!-- VIEW: ROADMAP (Hidden by default) -->
    <div id="view-roadmap" class="hidden">
        <div class="bg-white rounded-lg shadow-sm p-6 border border-stone-200">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">The Complexity Ascent</h2>
            <p class="text-slate-600 mb-8">This visualization tracks the cumulative "Grammatical Load" across the learning journey. Notice how the complexity spikes at the B2 transition point, where abstract concepts are introduced.</p>

            <div class="chart-container">
                <canvas id="roadmapChart"></canvas>
            </div>
        </div>
    </div>

</main>

<!-- Modal for Topic Details -->
<div id="topic-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all flex flex-col">
        <div class="p-6 flex-grow overflow-y-auto">
            <div class="flex justify-between items-start">
                <div>
                    <span id="modal-category" class="inline-block px-2 py-1 text-xs font-semibold rounded bg-blue-100 text-blue-800 mb-2">Category</span>
                    <h3 id="modal-title" class="text-2xl font-bold text-slate-900">Topic Title</h3>
                </div>
                <button onclick="app.closeModal()" class="text-slate-400 hover:text-slate-500 text-2xl font-bold">&times;</button>
            </div>

            <div class="mt-6 space-y-6">
                <div>
                    <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wide">Concept Summary</h4>
                    <p id="modal-desc" class="mt-2 text-slate-700 leading-relaxed">Description goes here.</p>
                </div>

                <div class="bg-stone-50 p-4 rounded-md border border-stone-200">
                    <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wide mb-2">Key Examples</h4>
                    <ul id="modal-examples" class="list-disc list-inside text-slate-700 space-y-1">
                        <!-- JS populated -->
                    </ul>
                </div>

                <div class="bg-indigo-50 p-4 rounded-md border border-indigo-100">
                    <h4 class="text-sm font-bold text-indigo-800 uppercase tracking-wide mb-2 flex items-center">
                        <span>Teacher's Tip</span>
                    </h4>
                    <p id="modal-tip" class="text-indigo-900 text-sm">Tip content.</p>
                </div>

                <!-- AI Assistant Section -->
                <div class="mt-6 border-t border-stone-200 pt-6">
                    <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wide mb-3 flex items-center gap-2">
                        <span>AI Assistant</span>
                        <span class="px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 text-xs font-medium">Gemini Powered</span>
                    </h4>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="app.generateLessonPlan()" id="btn-lesson-plan" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors text-sm font-medium shadow-sm">
                            <span>✨ Generate Lesson Plan</span>
                        </button>
                        <button onclick="app.generateMoreExamples()" id="btn-examples" class="flex items-center gap-2 px-4 py-2 bg-white border border-stone-300 text-slate-700 rounded-md hover:bg-stone-50 transition-colors text-sm font-medium shadow-sm">
                            <span>✨ Get More Examples</span>
                        </button>
                    </div>

                    <!-- AI Output Container -->
                    <div id="ai-output" class="mt-4 hidden animate-fade-in">
                        <div id="ai-loading" class="flex items-center gap-2 text-slate-500 text-sm italic p-4 bg-stone-50 rounded-md border border-stone-200">
                            <div class="animate-spin h-4 w-4 border-2 border-purple-500 border-t-transparent rounded-full"></div>
                            <span id="ai-loading-text">Consulting the AI...</span>
                        </div>
                        <div id="ai-content-box" class="hidden">
                            <div id="ai-content" class="ai-content text-sm text-slate-700 bg-white p-6 rounded-md border border-purple-200 shadow-inner"></div>
                        </div>
                        <div id="ai-error" class="hidden text-red-600 text-sm p-4 bg-red-50 rounded-md border border-red-200 mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-6 border-t border-stone-100 bg-stone-50 rounded-b-lg flex justify-end">
            <button onclick="app.closeModal()" class="px-4 py-2 bg-white border border-stone-300 text-slate-700 rounded hover:bg-stone-50 transition-colors font-medium">Close</button>
        </div>
    </div>
</div>

<footer class="bg-stone-100 border-t border-stone-200 mt-12 py-8">
    <div class="max-w-7xl mx-auto px-4 text-center text-slate-500 text-sm">
        <p>&copy; 2023 GrammarPath. Designed for EFL/ESL Educators.</p>
    </div>
</footer>

<!-- LOGIC -->
<script>
    const apiKey = ""; // Set by environment

    // Gemini API Helper with Retry Logic
    async function callGemini(prompt, systemInstruction = "") {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] }
        };

        const delays = [1000, 2000, 4000];

        for (let i = 0; i <= delays.length; i++) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
            } catch (error) {
                if (i === delays.length) throw error; // Rethrow last error
                await new Promise(resolve => setTimeout(resolve, delays[i]));
            }
        }
    }

    // Simple Markdown Parser (Bold, Lists, Headers, Line Breaks)
    function parseMarkdown(text) {
        let html = text
            // Headers
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            // Bold
            .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
            // Unordered Lists - Handle newlines before lists for spacing
            .replace(/^\s*[\-\*] (.*)/gim, '<ul><li>$1</li></ul>')
            // Fix nested lists (merge adjacent ul tags)
            .replace(/<\/ul>\s*<ul>/gim, '')
            // Numbered Lists
            .replace(/^\d+\. (.*)/gim, '<ol><li>$1</li></ol>')
            .replace(/<\/ol>\s*<ol>/gim, '')
            // Line Breaks
            .replace(/\n/gim, '<br>');
        return html;
    }

    // --- DATA STORE ---
    // Organized by CEFR Levels. Topics are strictly ordered by recommended teaching sequence.
    const grammarData = {
        'A1': {
            title: "The Foundation",
            desc: "Focus on survival English: basic sentence structures, essential verbs, and concrete nouns. The goal is simple communication.",
            topics: [
                { id: 'a1_1', title: "Personal Pronouns & To Be", category: "Structure", desc: "I, You, He, She, It, We, They. Conjugation of 'to be' (am, is, are).", examples: ["I am a teacher.", "She is happy.", "They are students."], tip: "Don't rush this. Use physical gestures to demonstrate pronouns. Ensure 'It' vs 'He/She' is clear." },
                { id: 'a1_2', title: "Articles: A / An / The", category: "Nouns", desc: "Indefinite vs Definite articles. Basic rules for singular countable nouns.", examples: ["It is a cat.", "It is an apple.", "The cat is black."], tip: "Start with a/an based on sound, not spelling. Introduce 'The' only for specific/unique items initially." },
                { id: 'a1_3', title: "Plural Nouns (Regular)", category: "Nouns", desc: "Adding -s and -es to nouns.", examples: ["One dog, two dogs.", "One bus, two buses."], tip: "Focus on pronunciation of the 's' ending (/s/, /z/, /iz/)." },
                { id: 'a1_4', title: "Demonstratives: This/That", category: "Determiners", desc: "Pointing to near vs far objects (singular).", examples: ["This is my book.", "That is your car."], tip: "Use physical distance in the classroom to teach this." },
                { id: 'a1_5', title: "Possessive Adjectives", category: "Adjectives", desc: "My, Your, His, Her, Its, Our, Their.", examples: ["This is my pen.", "Her name is Sarah."], tip: "Contrast with subject pronouns explicitly (I vs My)." },
                { id: 'a1_6', title: "Present Simple (Positive)", category: "Tenses", desc: "Facts, habits, and routines. 3rd person 's'.", examples: ["I like pizza.", "He plays football."], tip: "The 3rd person 's' is the most common error. Drill it extensively." },
                { id: 'a1_7', title: "Present Simple (Negative/Question)", category: "Tenses", desc: "Using 'Do/Does' as auxiliary verbs.", examples: ["I do not know.", "Do you like coffee?"], tip: "Explain that 'do/does' carries the tense/person, leaving the main verb in base form." },
                { id: 'a1_8', title: "Basic Prepositions of Place", category: "Prepositions", desc: "In, On, Under, Next to.", examples: ["The book is on the table."], tip: "Use a box and a ball for visual demonstration." },
                { id: 'a1_9', title: "There is / There are", category: "Structure", desc: "Existence and quantity.", examples: ["There is a pen.", "There are two chairs."], tip: "Connect this with the prepositions topic (e.g., There is a pen on the table)." },
                { id: 'a1_10', title: "Can / Can't (Ability)", category: "Modals", desc: "Expressing basic ability.", examples: ["I can swim.", "I can't fly."], tip: "Emphasize that modals don't change for He/She/It." }
            ]
        },
        'A2': {
            title: "Expanding Horizons",
            desc: "Moving beyond 'here and now'. Talking about the past, future, and describing things with more detail.",
            topics: [
                { id: 'a2_1', title: "Past Simple (To Be)", category: "Tenses", desc: "Was / Were.", examples: ["I was tired.", "They were at home."], tip: "Teach this before Past Simple of regular verbs." },
                { id: 'a2_2', title: "Past Simple (Regular)", category: "Tenses", desc: "Adding -ed for finished actions.", examples: ["I played tennis.", "We walked home."], tip: "Focus on the three pronunciations of -ed (/t/, /d/, /id/)." },
                { id: 'a2_3', title: "Past Simple (Irregular)", category: "Tenses", desc: "Common irregular verbs (go-went, see-saw).", examples: ["I went to the park.", "She saw a movie."], tip: "Don't give a huge list at once. Group them by sound patterns." },
                { id: 'a2_4', title: "Countable vs Uncountable", category: "Nouns", desc: "Concepts of quantity. Much vs Many.", examples: ["Water (uncountable)", "Apples (countable)"], tip: "Use food items as the primary context." },
                { id: 'a2_5', title: "Comparatives & Superlatives", category: "Adjectives", desc: "Comparing two or more things (-er, -est, more, most).", examples: ["Faster than", "The most beautiful"], tip: "Highlight the irregulars (good/better/best) early." },
                { id: 'a2_6', title: "Present Continuous", category: "Tenses", desc: "Actions happening now vs Present Simple routines.", examples: ["I am eating now.", "I usually eat at 6."], tip: "Use timelines to show the difference visually." },
                { id: 'a2_7', title: "Future: Going to", category: "Tenses", desc: "Plans and predictions based on evidence.", examples: ["I am going to buy a car."], tip: "Contrast 'plans' with spontaneous decisions later." },
                { id: 'a2_8', title: "Adverbs of Frequency", category: "Adverbs", desc: "Always, usually, often, sometimes, never.", examples: ["I always wake up early."], tip: "Focus on sentence placement (before main verb, after 'to be')." },
                { id: 'a2_9', title: "Possessive 's", category: "Nouns", desc: "Ownership rules.", examples: ["John's car.", "My parents' house."], tip: "Be careful distinguishing plural 's' from possessive 's'." },
                { id: 'a2_10', title: "Prepositions of Time", category: "Prepositions", desc: "In (months/years), On (days), At (times).", examples: ["In 1999", "On Monday", "At 5pm"], tip: "Draw a pyramid: At (top/small), On (middle), In (bottom/big)." }
            ]
        },
        'B1': {
            title: "The Bridge to Fluency",
            desc: "Connecting ideas, more complex tenses, and conditionals. Students start to express abstract thoughts.",
            topics: [
                { id: 'b1_1', title: "Present Perfect Simple", category: "Tenses", desc: "Experiences and unfinished past.", examples: ["I have been to Paris.", "She has lived here for 2 years."], tip: "The hardest topic for many. Contrast sharply with Past Simple (Finished vs Unfinished time)." },
                { id: 'b1_2', title: "For vs Since", category: "Prepositions", desc: "Duration vs Starting point.", examples: ["For 2 hours", "Since 2 o'clock"], tip: "Link directly to Present Perfect." },
                { id: 'b1_3', title: "Zero & First Conditional", category: "Structure", desc: "Facts (Zero) and Real Possibilities (First).", examples: ["If you heat ice, it melts.", "If it rains, I will stay home."], tip: "Focus on the structure: If + Present, ... Future/Present." },
                { id: 'b1_4', title: "Modals of Deduction (Present)", category: "Modals", desc: "Must, Might, Can't (Certainty).", examples: ["He must be tired.", "It can't be true."], tip: "Teach this as a scale of probability %." },
                { id: 'b1_5', title: "Passive Voice (Simple)", category: "Structure", desc: "Focus on the object/action, not the doer.", examples: ["The glass was broken.", "English is spoken here."], tip: "Start with simple transformations. Explain 'Why' we use it (unknown agent)." },
                { id: 'b1_6', title: "Past Continuous", category: "Tenses", desc: "Interrupted actions in the past.", examples: ["I was sleeping when you called."], tip: "Use 'While' vs 'When' to connect clauses." },
                { id: 'b1_7', title: "Used to", category: "Structure", desc: "Past habits/states that are no longer true.", examples: ["I used to smoke."], tip: "Contrast with 'Be used to' (B2 topic) to avoid confusion." },
                { id: 'b1_8', title: "Quantifiers", category: "Determiners", desc: "A few, A little, Plenty of, None of.", examples: ["I have a little money."], tip: "Review countable/uncountable first." },
                { id: 'b1_9', title: "Relative Clauses (Defining)", category: "Structure", desc: "Who, which, that (Essential info).", examples: ["The man who called me."], tip: "Students often omit the relative pronoun or use the wrong one." },
                { id: 'b1_10', title: "Indefinite Pronouns", category: "Pronouns", desc: "Something, Anywhere, Nobody.", examples: ["Is anyone home?"], tip: "Treat them as singular verbs." }
            ]
        },
        'B2': {
            title: "Complexity & Nuance",
            desc: "Advanced structures, hypothetical situations, and mastering narrative tenses.",
            topics: [
                { id: 'b2_1', title: "Second Conditional", category: "Structure", desc: "Hypothetical present/future.", examples: ["If I won the lottery, I would travel."], tip: "Great for discussion classes (Would you rather...?)." },
                { id: 'b2_2', title: "Third Conditional", category: "Structure", desc: "Regrets and hypothetical past.", examples: ["If I had studied, I would have passed."], tip: "Pronunciation drill: 'I'd have' /aɪdəv/." },
                { id: 'b2_3', title: "Past Perfect Simple", category: "Tenses", desc: "The 'past of the past'.", examples: ["When I arrived, the train had left."], tip: "Use timelines to clearly show event A happening before event B." },
                { id: 'b2_4', title: "Reported Speech", category: "Structure", desc: "Backshifting tenses.", examples: ["He said he liked it."], tip: "Create a conversion chart for tenses (Present -> Past, etc.)." },
                { id: 'b2_5', title: "Future Continuous & Perfect", category: "Tenses", desc: "Actions in progress or finished at a future time.", examples: ["I will be flying...", "I will have finished..."], tip: "Focus on 'By [time]' time markers." },
                { id: 'b2_6', title: "Passive (Advanced)", category: "Structure", desc: "Passive with modals, infinitives, and 'It is said...'", examples: ["It is believed that...", "The work must be done."], tip: "Focus on formal/academic writing contexts." },
                { id: 'b2_7', title: "Gerunds vs Infinitives", category: "Verbs", desc: "Verbs followed by -ing or to...", examples: ["Enjoy swimming", "Want to go"], tip: "There is no rule for many of these; it requires memorization and exposure." },
                { id: 'b2_8', title: "Articles (Advanced)", category: "Nouns", desc: "Geographical rules, institutions (school vs the school).", examples: ["I go to prison (inmate) vs the prison (visitor)."], tip: "Focus on nuance and meaning changes." },
                { id: 'b2_9', title: "Relative Clauses (Non-Defining)", category: "Structure", desc: "Extra information, using commas.", examples: ["My mom, who is 60, lives here."], tip: "Emphasize comma usage and that 'that' cannot be used." },
                { id: 'b2_10', title: "So / Such / Too / Enough", category: "Adverbs", desc: "Intensifiers and sufficiency.", examples: ["It was such a good day.", "It's too loud."], tip: "Common error: 'Too much big'." }
            ]
        },
        'C1': {
            title: "Advanced Structure",
            desc: "Stylistic variety, emphasis, and subtle meaning changes.",
            topics: [
                { id: 'c1_1', title: "Mixed Conditionals", category: "Structure", desc: "Combining 2nd and 3rd types (Past cause, present result).", examples: ["If I hadn't eaten that, I wouldn't be sick now."], tip: "Requires mastery of standard conditionals first." },
                { id: 'c1_2', title: "Inversion", category: "Structure", desc: "Negative adverbials for emphasis.", examples: ["Never have I seen...", "Rarely do we go..."], tip: "Teach this as a tool for formal writing/speeches." },
                { id: 'c1_3', title: "Cleft Sentences", category: "Structure", desc: "Changing focus with 'It' or 'What'.", examples: ["It was John who called.", "What I need is sleep."], tip: "Show how this changes the stress in spoken English." },
                { id: 'c1_4', title: "Participle Clauses", category: "Structure", desc: "Shortening clauses using -ing or -ed.", examples: ["Walking down the street, I saw...", "Shocked by the news, he cried."], tip: "Ensure the subject is the same in both clauses." },
                { id: 'c1_5', title: "Subjunctive Mood", category: "Structure", desc: "Formal recommendations/demands.", examples: ["I suggest that he be present.", "It is vital that she go."], tip: "Often disappears in British English (should be), but common in US English." },
                { id: 'c1_6', title: "Advanced Phrasal Verbs", category: "Vocabulary", desc: "3-part phrasal verbs, separating verbs.", examples: ["Come up with", "Look down on"], tip: "Teach by theme, not alphabetical list." },
                { id: 'c1_7', title: "Future in the Past", category: "Tenses", desc: "Was going to, Was to have been.", examples: ["I was going to call you, but I forgot."], tip: "Useful for excuses and changed plans." },
                { id: 'c1_8', title: "Wish / If only", category: "Structure", desc: "Regrets about present and past.", examples: ["I wish I were taller.", "If only I hadn't said that."], tip: "Similar logic to 2nd/3rd conditionals." },
                { id: 'c1_9', title: "Verb Patterns (Object + Infinitive)", category: "Verbs", desc: "Advise someone to do, Make someone do.", examples: ["I advise you to go.", "He made me cry."], tip: "Focus on 'Make' and 'Let' (no 'to')." },
                { id: 'c1_10', title: "Gradable vs Ungradable Adjectives", category: "Adjectives", desc: "Very tired vs Absolutely exhausted.", examples: ["Absolutely furious (not very furious)."], tip: "Pair adjectives with their correct intensifiers." }
            ]
        },
        'C2': {
            title: "Mastery & Style",
            desc: "Total control over tone, register, and archaic forms for specific effects.",
            topics: [
                { id: 'c2_1', title: "Ellipsis & Substitution", category: "Structure", desc: "Omitting words to avoid repetition.", examples: ["She likes it and so do I.", "Do you think so?"], tip: "Critical for natural, native-level fluency." },
                { id: 'c2_2', title: "Nominalisation", category: "Style", desc: "Turning verbs/adjectives into nouns for academic weight.", examples: ["The implementation of the plan... (vs They implemented)."], tip: "Essential for academic writing (IELTS/TOEFL)." },
                { id: 'c2_3', title: "Hedgeing", category: "Style", desc: "Softening statements.", examples: ["It is arguably true...", "It would appear that..."], tip: "Politeness strategies in English culture." },
                { id: 'c2_4', title: "Discourse Markers (Advanced)", category: "Structure", desc: "Structuring complex arguments.", examples: ["Notwithstanding,", "Conversely,", "To that end,"], tip: "Focus on text cohesion." },
                { id: 'c2_5', title: "Inversion (Conditionals)", category: "Structure", desc: "Dropping 'If'.", examples: ["Had I known...", "Should you require..."], tip: "Very formal/business context." },
                { id: 'c2_6', title: "Fronting", category: "Structure", desc: "Moving objects/complements to the front.", examples: ["Strange it was.", "Next to the door stood a man."], tip: "Used in storytelling and descriptive writing." },
                { id: 'c2_7', title: "Subtle Modals", category: "Modals", desc: "Dare, Needn't have vs Didn't need to.", examples: ["You needn't have bought it (but you did)."], tip: "Fine-tuning meaning." },
                { id: 'c2_8', title: "Multi-word Verbs & Nouns", category: "Vocabulary", desc: "Complex compounds.", examples: ["A passers-by", "Output", "Breakdown"], tip: "Stress patterns in compounds." },
                { id: 'c2_9', title: "Stylistic Archaic Forms", category: "Style", desc: "Whom, Thereof, Whereby.", examples: ["The means whereby..."], tip: "Only for legal or highly formal contexts." },
                { id: 'c2_10', title: "Patterns of Comparison", category: "Adjectives", desc: "The... the...", examples: ["The more I study, the less I know."], tip: "Parallel structure is key here." }
            ]
        }
    };

    const app = {
        currentLevel: 'A1',
        charts: {},
        currentTopicData: null,

        init: function() {
            this.loadLevel('A1');
            this.renderRoadmap();
        },

        showSection: function(sectionId) {
            // Hide all sections
            document.getElementById('view-curriculum').classList.add('hidden');
            document.getElementById('view-roadmap').classList.add('hidden');

            // Show selected
            document.getElementById(`view-${sectionId}`).classList.remove('hidden');
        },

        loadLevel: function(level) {
            this.currentLevel = level;

            // 1. Update Tabs
            document.querySelectorAll('nav button').forEach(btn => {
                btn.className = 'tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm w-1/6 text-center transition-colors';
            });
            document.getElementById(`tab-${level}`).className = 'tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm w-1/6 text-center transition-colors';

            // 2. Load Content
            const data = grammarData[level];
            const contentDiv = document.getElementById('level-content');

            contentDiv.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Level Info Column -->
                        <div class="lg:col-span-2">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                                <h2 class="text-2xl font-bold text-slate-800 mb-2">${level}: ${data.title}</h2>
                                <p class="text-slate-600 mb-6">${data.desc}</p>

                                <h3 class="font-bold text-slate-700 mb-4 uppercase text-xs tracking-wider">Curriculum Topics (In Order)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${data.topics.map((t, index) => `
                                        <div onclick="app.openModal('${level}', ${index})" class="topic-card bg-white p-4 rounded border border-stone-200 cursor-pointer group">
                                            <div class="flex justify-between items-start mb-2">
                                                <span class="text-xs font-semibold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">${t.category}</span>
                                                <span class="text-xs text-stone-400">#${index + 1}</span>
                                            </div>
                                            <h4 class="font-bold text-slate-800 group-hover:text-blue-700 transition-colors">${t.title}</h4>
                                            <p class="text-sm text-slate-500 mt-1 truncate">${t.desc}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Level Stats Column -->
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                                <h3 class="font-bold text-slate-700 mb-4 text-center">Grammar Focus Distribution</h3>
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="levelChart"></canvas>
                                </div>
                                <p class="text-xs text-center text-stone-500 mt-4">Shows the balance of Tenses vs Structural rules for this level.</p>
                            </div>

                            <div class="bg-indigo-50 p-6 rounded-lg border border-indigo-100">
                                <h3 class="font-bold text-indigo-900 mb-2">Teacher's Note</h3>
                                <p class="text-sm text-indigo-800 leading-relaxed">
                                    In level <strong>${level}</strong>, prioritize ${this.getLevelFocus(level)}.
                                    Do not move to the next level until at least 80% of these concepts are fluent in spoken production.
                                </p>
                            </div>
                        </div>
                    </div>
                `;

            // 3. Render Chart for this level
            setTimeout(() => this.renderLevelChart(level), 100);
        },

        getLevelFocus: function(level) {
            const map = {
                'A1': 'confidence and basic sentence construction',
                'A2': 'past narration and describing the world around them',
                'B1': 'connecting ideas and experiences using perfect tenses',
                'B2': 'hypothetical situations and complex narrative flow',
                'C1': 'precision, nuance, and stylistic variety',
                'C2': 'cultural subtlety and academic rigor'
            };
            return map[level];
        },

        renderLevelChart: function(level) {
            const topics = grammarData[level].topics;
            // Count categories
            const categories = {};
            topics.forEach(t => {
                categories[t.category] = (categories[t.category] || 0) + 1;
            });

            const ctx = document.getElementById('levelChart').getContext('2d');

            // Destroy old chart if exists
            if (this.charts.level) this.charts.level.destroy();

            this.charts.level = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            '#94a3b8', '#64748b', '#cbd5e1', '#e2e8f0', '#475569', '#334155'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                    }
                }
            });
        },

        renderRoadmap: function() {
            const ctx = document.getElementById('roadmapChart').getContext('2d');

            this.charts.roadmap = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Start', 'A1', 'A2', 'B1', 'B2', 'C1', 'C2'],
                    datasets: [{
                        label: 'Cognitive Load / Complexity',
                        data: [0, 15, 30, 50, 75, 90, 100],
                        borderColor: '#475569',
                        backgroundColor: 'rgba(71, 85, 105, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#475569',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Complexity Score' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const comments = [
                                        "Tabula Rasa",
                                        "Foundational structures laid.",
                                        "Past/Future concepts solid.",
                                        "Bridge to abstract thought.",
                                        "The 'Upper Intermediate Plateau' - Major jump.",
                                        "Nuance and sub-text mastery.",
                                        "Native-level manipulation."
                                    ];
                                    return comments[context.dataIndex];
                                }
                            }
                        }
                    }
                }
            });
        },

        openModal: function(level, index) {
            const topic = grammarData[level].topics[index];
            this.currentTopicData = topic; // Store for AI functions

            document.getElementById('modal-title').innerText = topic.title;
            document.getElementById('modal-category').innerText = topic.category;
            document.getElementById('modal-desc').innerText = topic.desc;
            document.getElementById('modal-tip').innerText = topic.tip;

            const examplesList = document.getElementById('modal-examples');
            examplesList.innerHTML = topic.examples.map(ex => `<li>${ex}</li>`).join('');

            // Reset AI Section
            document.getElementById('ai-output').classList.add('hidden');
            document.getElementById('ai-content-box').classList.add('hidden');
            document.getElementById('ai-error').classList.add('hidden');
            document.getElementById('btn-lesson-plan').disabled = false;
            document.getElementById('btn-examples').disabled = false;

            document.getElementById('topic-modal').classList.remove('hidden');
        },

        closeModal: function() {
            document.getElementById('topic-modal').classList.add('hidden');
        },

        // --- AI FEATURES ---

        setAiLoading: function(isLoading, text = "Consulting the AI...") {
            const loadingDiv = document.getElementById('ai-loading');
            const contentDiv = document.getElementById('ai-content-box');
            const errorDiv = document.getElementById('ai-error');
            const outputContainer = document.getElementById('ai-output');

            if (isLoading) {
                outputContainer.classList.remove('hidden');
                loadingDiv.classList.remove('hidden');
                document.getElementById('ai-loading-text').innerText = text;
                contentDiv.classList.add('hidden');
                errorDiv.classList.add('hidden');
                document.getElementById('btn-lesson-plan').disabled = true;
                document.getElementById('btn-examples').disabled = true;
            } else {
                loadingDiv.classList.add('hidden');
                document.getElementById('btn-lesson-plan').disabled = false;
                document.getElementById('btn-examples').disabled = false;
            }
        },

        generateLessonPlan: async function() {
            if (!this.currentTopicData) return;

            this.setAiLoading(true, "Designing a custom lesson plan...");
            const topic = this.currentTopicData;
            const level = this.currentLevel;

            const systemInstruction = "You are an expert ESL/EFL Curriculum Designer with 20 years of experience. You create concise, practical, and highly structured lesson plans.";

            const prompt = `Create a 45-minute lesson plan for a class of ${level} level students on the topic: "${topic.title}".

                Context: ${topic.desc}
                Key Difficulty: ${topic.tip}

                Please output the response in strictly structured Markdown format using the following headers:
                # Lesson Plan: ${topic.title}
                ## Learning Objective
                [One clear objective]
                ## 1. Warm-up (5 mins)
                [Activity details]
                ## 2. Presentation (10 mins)
                [How to explain the concept simply]
                ## 3. Practice (15 mins)
                [Structured exercises or drilling ideas]
                ## 4. Production (15 mins)
                [A speaking or writing activity to use the grammar freely]

                Keep the tone encouraging and professional.`;

            try {
                const response = await callGemini(prompt, systemInstruction);
                const formattedHtml = parseMarkdown(response);

                const contentBox = document.getElementById('ai-content-box');
                const contentText = document.getElementById('ai-content');

                contentText.innerHTML = formattedHtml;
                contentBox.classList.remove('hidden');
            } catch (error) {
                const errorDiv = document.getElementById('ai-error');
                errorDiv.innerText = "Error generating lesson plan. Please check your connection or try again.";
                errorDiv.classList.remove('hidden');
                console.error(error);
            } finally {
                this.setAiLoading(false);
            }
        },

        generateMoreExamples: async function() {
            if (!this.currentTopicData) return;

            this.setAiLoading(true, "Creating new examples...");
            const topic = this.currentTopicData;
            const level = this.currentLevel;

            const systemInstruction = "You are an English teacher. You generate clear, grammatically correct example sentences.";

            const prompt = `Generate 5 distinct, practical example sentences demonstrating the grammar topic "${topic.title}" specifically for CEFR Level ${level} students.

                The sentences should be:
                1. Contextual (not just abstract grammar).
                2. Varied (positive, negative, question forms if applicable).
                3. Uses vocabulary appropriate for ${level} level.

                Output format: Just a simple bulleted list in Markdown.`;

            try {
                const response = await callGemini(prompt, systemInstruction);
                const formattedHtml = parseMarkdown(response);

                const contentBox = document.getElementById('ai-content-box');
                const contentText = document.getElementById('ai-content');

                contentText.innerHTML = `<h3>✨ Fresh Examples for ${topic.title}</h3>` + formattedHtml;
                contentBox.classList.remove('hidden');
            } catch (error) {
                const errorDiv = document.getElementById('ai-error');
                errorDiv.innerText = "Error generating examples. Please try again.";
                errorDiv.classList.remove('hidden');
            } finally {
                this.setAiLoading(false);
            }
        }
    };

    // Initialize app on load
    document.addEventListener('DOMContentLoaded', () => {
        app.init();
    });

</script>
</body>
</html>